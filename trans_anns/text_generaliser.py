import spacy
import en_core_web_sm as enmodel
import sqldbutils as dutil
import utils
from os.path import join, exists, isfile
import sys
import sentence_pattern as sp


def load_mode(model_name):
    if model_name == 'en':
        return enmodel.load()
    return None


def doc_processing(nlp, doc_text, anns):
    """
    pick up relevant sentences with labelled annotations and send them for sentence level processing
    :param nlp:
    :param doc_text:
    :param anns:
    :return:
    """
    doc = nlp(doc_text)
    pos = 0
    matched_sent_anns = []
    for sent in doc.sents:
        s = pos
        e = pos + len(sent.text)
        idx = 0
        m_anns = []
        for ann in anns:
            if ann['s'] >= s and ann['e'] <= e:
                m_anns.append(ann)
            idx += 1
        if len(m_anns) > 0:
            matched_sent_anns.append({'sent': sent, 'sent_offset': pos, 'anns': m_anns})
            anns = [ann for ann in anns if ann not in m_anns]
        pos = e
        # print '%s-%s, %s: [%s]' % (s, e, doc_text.index(sent.text), sent.text)
    # print matched_sent_anns
    ptn_inst = []
    for s in matched_sent_anns:
        ptn = sp.POSSentencePatternInst(s['sent'], s['anns'])
        ptn.process()
        ptn_inst.append(ptn)
        # print '>>%s: >>%s\n' % (ret['sent'], ret['pattern'])
    return ptn_inst


def generalise_sent_pos(s):
    """
    generalise sentence pattern by POS tags only
    :param s:
    :return:
    """
    rets = []
    for token in s['sent']:
        e = token.idx + len(token.text)
        is_matched = False
        for ann in s['anns']:
            if token.idx >= ann['s'] and e <= ann['e']:
                rets.append((token.text, token.pos_, True, ann['signed_label'], ann['gt_label']))
                is_matched = True
                break
        # print '%s-%s, %s: [%s]' % (token.idx, e, token.idx, token.text)
        if not is_matched:
            rets.append((token.text, token.pos_))
    return {"sent": s['sent'].text, 'pattern': rets}


def word2vec_testing():
    nlp = spacy.load('en_core_web_lg')
    tokens = nlp(u'think concern have')
    for token1 in tokens:
        for token2 in tokens:
            print('%s vs %s:' % (token1.text, token2.text),
                  token1.similarity(token2))


def download_docs(doc_ids, query, db_conn_setting, out_put_folder):
    """
    download clinical notes from EHR
    :param doc_ids:
    :param query:
    :param db_conn_setting:
    :return:
    """
    db_cnn = dutil.get_db_connection_by_setting(db_conn_setting)
    results = []
    q = query.format(**{'ids': ','.join(['\'%s\'' % did for did in doc_ids])} )
    print 'querying [%s]' % q
    print q
    dutil.query_data(q, results, db_cnn)
    for r in results:
        if r['textcontent'] is not None:
            utils.save_string(r['textcontent'].decode('cp1252').replace(chr(13), ' '), join(out_put_folder, r['cn_doc_id'] + '.txt'), encoding='utf-8')


def do_process_labelled_doc(doc_anns, container):
    doc_id = doc_anns[0]
    anns = doc_anns[1]
    doc = utils.read_text_file_as_string(join(working_folder, 'docs', '%s.txt' % doc_id),
                                         encoding='utf-8')    # print doc
    container += doc_processing(nlp,
                                doc,
                                anns)


def process_labelled_docs(labelled_file, corpus_model_file):
    if not isfile(corpus_model_file):
        # load labelled data
        ann_lines = utils.read_text_file(labelled_file)
        prev_doc = None
        anns = []
        doc_anns = []
        ptn_insts = []
        for ls in ann_lines:
            l = ls.split('\t')
            doc_id = l[0]
            if prev_doc != doc_id:
                if prev_doc is not None:
                    if exists(join(working_folder, 'docs', '%s.txt' % prev_doc)):
                        doc_anns.append((prev_doc, anns))
                anns = []
                prev_doc = doc_id
            anns.append({'s': int(l[1]), 'e': int(l[2]), 'signed_label': l[3], 'gt_label': l[4]})
        if prev_doc is not None:
            if exists(join(working_folder, 'docs', '%s.txt' % prev_doc)):
                doc_anns.append((prev_doc, anns))
        # mutithreading do processing labelled docs
        print 'processing docs...'
        utils.multi_thread_tasking(doc_anns, 30, do_process_labelled_doc, args=[ptn_insts])
        print 'merging patterns..'
        corpus_analyzer = sp.CorpusAnalyzer()
        for pi in ptn_insts:
            corpus_analyzer.add_pattern(pi)
        corpus_analyzer.serialise(corpus_model_file)
        corpus_analyzer.show()
    else:
        corpus_analyzer = sp.CorpusAnalyzer.load_seralisation(corpus_model_file)
        corpus_analyzer.show()


if __name__ == "__main__":
    # word2vec_testing()
    # sentence_parsing(u'Routine blood investigation and virology for Hep C done')
    reload(sys)
    sys.setdefaultencoding('cp1252')
    working_folder = "C:/Users/HWu/Documents/actionable_trans"
    # 1. download texts from EHR
    # download_docs(['24354507','27609723','40062014','149425181194749','149400861194586','149396671194565','149447071194919','14943479','17292563','172924021388374','172914961388305','25294151158113','27246317299740','27246217299720','17293004','17293087','27366680','27375550','18349148','18358440','18368726','18371496','18382963','33729806','35812324','35831321','38327642','38637411','39563201','41773795','45420679','45599655','46358994','46427268','46450905','46577617','47839417','49681779','49696363','49709836','183901641475217','337479311257546','183809001474459','463583302839822','488303253147622','18362990','18371422','18380951','18392239','18392762','18393873','18394749','43350166','46438016','47033422','47131128','477172123007805','183942861475528','183541171472187','183770351474115','183736921473881','28863918395258','406482162117698','183637971472990','183598191472701','408700022147707','28346412544869','18366000','47259738','48842992','35813214','38001988','28863418395102','49530613','21329849','33710602','21331206','21333448','213335101710295','213338021710323','21334433','37713159','153276571225111','30754181','32622783','35302288','21636114','216399811734184','21634673','21634694','21634970','21635109','21635766','21636218','25664840','25664940','29975165','34412180','42592290','42592773','42733036','42955444','43865795','44440887','44568437','44721765','45140518','45192324','45197254','45532248','45626293','45865038','45887314','46423146','46423609','46544805','46657782','48002457','49617873','495585733237613','43228781','34411394','47101381','42742343','48139837','23961985','24315447','24982524','28416360','32362043','33765504','30054740','49268041','26703135330562','31351804941880','26775134','31413864','27105384381167','12208727974316','39129020','36119860','19528190','19528593','19528646','19528998','19529140','19531762','44182302','44759905','45712709','45849879','195286171565635','31794164998508','19528289','19528354','19528805','19528699','43489530','15448938','154495081234434','13878868','13879041','13879588','13880397','13881249','13883008','13885552','27633423','28077157','28259162','28457397','29181536','29568481','48432066','48773120','25782363','27862263','27864119','28729973','29100601','29405248','40255979','40777402','138855051108951','28457548559503','138853331108931','353277191450069','13879498','13880678','35325947','29100657641812','14033759','140343841120766','140344221120769','140371831121016','140366071120959','14034920','14034984','14033315','14033390','14033569','14033587','14033609','39092542','41972902','24067950','26966700','28851226','29003797','29336842753423','167878711346081','2451580864889','167887901346168','16787512','16787714','24032430','26544397','28983828','29560209','29972177','30249424795221','28764367','30147481','31917431','40862008','40923857','41267556','28764480598183','36785632','367856531633087','367858001633119','39118413','42811004','43446358','32520386','39148301','26098011','29976310','37686815','37689411','37700962','37759932','377009711766613','416785102246405','377580641760169','376865091751092','133076931061691','26098287254854','13308509','13310038','37766040','37956064','38257129','43950078','43950237','44067496','133092951061793','440710622551707','44032626','441606492562178','24352788','24670422','25179804','25389669','25778812','34700768','35129068','36844194','25991052240976','25144512','35325682','25693806205832','353274851450039','221087761772513','221130601772919','26160850262702','347429391378273','25180055142656','22113288','35572298','22110864','22112259','37810574','37819061','35799968','42876276','42949271','40084155','22040460','22040562','22040879','22041411','220415561767069','220431161767136','220435821767164','220502121767551','220510351767614','220452871767259','22040949','220452021767251','32611359','33336582','33463642','33463643','33466754','33481575','37379039','37430439','37430768','37938542','40816534','43403626','43570046','44465768','44472090','30898039','32609693','41182096','44463742','450112562671389','341118021303492','408211742140067','19692628','25061187','25985853','25999965','26216249','26483117302687','19690456','13938359','13938706','13942423','25324572','26597387','35499648','38675187','38739226','139373871112889','26111084256446','139372841112875','13938817','139440001113394','26649939323722','13937966','13938126','13938229','13938571','41693846','41695644','42576354','13970106','42575123','43657100','44653258','31591108971504','28415184554335','139687581115431','16789617','25153455','25096573','25300147159026','26430178296465','13845517','13853276','13853287','13853307','13853356','42627349','42915616','44463689','44580914','44742504','44886414','45170170','48830558','48830564','48835610','425424632356014','425424632356474','425424632356035','138493581105765','13851672','13852496','138531261106063','138515741105966','138449441105506','17005255','17005279','17005617','170052121365185','17005190','17005232','17005321','170058491365222','26308263281606','26352269286961','26308368','29192231','32024955','32127036','33420703','40815679','321321441044500','321318311044434','371961271686029','32129617','35973361','37267720','37687077','38358112','39028233','39785678','40083413','41047066','41935168','32803942','40372812','37987811','15785074','15785165','15787831','15788024','15788207','15788240','38710620','39025028','15790084','157902891262527','25658200201753','25103211','27056773','27068437','30887099','36995441','37544081','39307246','39661546','49427216','135559061081434','13554190','13556834','13556862','13557159','25518501','48506310','2441390952585','13555150','13555650','30835849','25076346','26989382','30623024','25090291132493','13485386','39760517','398025492008156','134845551076140','134839931076071','134854241076228','398651212016824','13483697','13483898','13484666','13484918','24779458','30651806','39725719','39737374','40809140','46517662','397924352007750','27054153374763','2470790587653','34583566','349209221399388','2474456991767','27080278377546','45776860','45969022','45969047','15477292','25656316','25782483','26326614','26461476','28025059','28428034','31757557','26528249307545','16654873','26058453','26598745','28024351','30583100','31956133','31980165','32367846','33458270','33917975','38225202','43842974','44109763','46095418','21351047','32962604','36088853','37485613','38438662','39368765','48574410','398630342016510','389672351952574','21353239','21353596','27307247','30290404','30594039','32519497','32970830','38279534','39370088','40663860','42496670','42501999','43059933','43060002','44317227','46141704','406879192122338','213558071712010','389617531909227','45579946','48545676','321885791052057','32081056','12202089','12207346','23935068','28013698','38315133','38777855','32012583','37520056','24620662','25274240','25752161','30458559','30666563','31453672','31541688','31681844','33360682','35097920','35274995','43095548','43909146','44471811','44752148','45035943','45570846','45850300','46011140','46336556','46428611','47257648','47279106','47660929','48171374','48808406','48808423','49204193','49345237','49521850','24610386','28446812','31379383','31404785','31749139','35973579','37010802','41253264','44319467','45356371','47255807','47256948','31404815946948','446851762629946','28356601546417','34921836','39822495','42340666','42510724','42795098','43349978','28317751','14937717','24225105','24341707','36499938','43744481','45237015','46011074','46088878','46734218','46791540','48409346','2422515031144','26570677313276','468382032900599','33002519','44192535','484150133096501','443934782592160','48434688','19923911','25078974','25124811','25954563','28563438','28564614','28565170','36090993','26804027342234','26219350','28544391','35928039','35970867','25523223185577','26844140348867','21567208','21568018','21568378','45999510','47533395','48518438','48603739','48603790','48713713','49243269','49335268','487137153132432','485197473108935','487137153132431','34744637','45971005','47116379','47513530','47628123','471504802939443','46561517','48764815','24107510','24839593','25953296','26582703','36500019','37770872','26684134327836','35320649','35575518','36769070','37151789','37285253','486698283127176','34125173','30000583','368860601649974','419953102284824','17214006','27696662','37989981','46937476','48823586','48996191','49067610','488367603148692','489367173159294','381869341810885','34125263','41552871','28233842','29415316','29563883','30310748','30310906','30310961','30326203','30327590','30452925','34124985','37642276','39521479','43040365','43071284','130384711039815','404793642096108','30275276818540','29749848729230','30105137776200','29750301729324','406617782119633','13035210','13036394','13036944','130407441039971','30547937835032','130365871039674','37782297','40264262','41739144','30211115','30211148790902','13034685','22187446','22187894','26075026','26177958','31258361','41267675','41407033','41548041','42737451','43025280','43085893','43446456','43586759','44499079','45064622','30333430','221866541779311','36753868','44130362','44639209','44781754','15663066','25349911164476','25375686','15901123','28334559543234','218379181750976','26737480','30454592','30510484','31085865','31466008','32173551','33865111','34669995','34870738','35009093','35046465','35183520','360602231543391','26744507','368627781642927','30635931','32311510','33334075','27050924','19253353','39128100','46600330','47100901','47927554','48224970','49332436','48353655','48794529','46952878','21778581','185022101483822','444656782601421','396140091985123','38963540','2474442691743','16982567','28302439','35988985','37214278','39214303','39214395','39281792','48320344','26080879252534','26080921252536','325164811097369','348792641394877','393630451955579','391463081934711','17952593','35015756','35041107','35308230','35438432','39288006','39503219','39776183','49547266','49641304','347337321377030','352366181438254','30289804','48022985','48599094','34940360','47772487','28077377508676','128421581024890','128430161024981','128420121024878','23454374','319417831018256','23454361','23454438','234544441873046','206131091652119','21816573','21819382','21819958','42741928','42853190','43097826','455663542739168','367977201634747','367977201635088','44557321','43078483','405673832107021','20940672','20941008','20942048','20944264','25224774','29300737','38526411','439662922539615','209432131678287','209344991677667','209456671678480','239937197395','24856976105207','460651092801787','25714297207999','209457601678484','20936885','36228596','36274240','36410388','37466917','37686754','38040732','38382872','40085619','18307822','17878825','17879151','30811096','18896720','188967991514958','363135421623092','26221501270722','25260091','25235365150436','24436895','28150633','29317419','29317480','29317797','28247357544248','28727007594899','28453107','28476965','28477652','28489611','28535230569787','28489272','28544464','30635464','28898972','37309754','38352711','40117482','37266487','43440294','43562255','427730822385985','423302922327865','45598484','385548891858180','320970611039610','474717532978677','359058561523415','425208682351847','425208682351846','425208682351843','425361432354833','425361432354829','425916662362059','425916662362052','425935162362415','44338966','49165670','425935162362399','426305632367201','426305632367211','426572572371421','426590372371830','426590372371838','44574566','445746622615939','453443572710938','491669343187858','48983712','Doc ID','18751459','39294191','39294490','30359237810173','128033681021918','15444659','195143701564593','137683871098765','13767807','36527024','36600937','45410231','46813861','47379161','48120101','48120470','48197300','48226613','48233370','48322847','48469943','48793223','480932193055038','455164352732946','45409700','45432332','49204121','49799343','481225703059256','481446003061187','49258165','49429978','492428533197800','128665501026788','16878855','16880613','27873346','36745217','36988767','37136343','37403733','37685171','37825401','38769327','39295652','39432480','39700805','16879907','28339336','32870820','39053430','168793761353837','390788811923123','331131771177482','27609701445967','31249905925829','31722572989183','27057797375330','41550192','2470854387771','42527944','2478554196640','2460720875522','138531331106065','175249781406312','224280341797945','22430811','22430990','29584213','29585442','30281484','30346470','30346531','30413825','30593542','34041950','30513107830272','30291018801396','30724298857981','183668781473261','29414936','30255499','22166440','22166448','22166579','22166606','22166671','22167160','22167687','22167894','22168153','22168220','25633297','25487879181744','22168274','221683791777714','221683041777708','22166492','22169606','22167095','22166523','378858711776256','378858711775494','378777561774134','421151142300496','360927711547123','19526131','19526258','19526577','19526811','19529167','19529181','19529224','195289671565661','195265491565510','195261631565486','22374000','22374730','223747851793611','28551143572258','28114749513569','28553227572672','18973350','189734291521293','18973562','189734571521295','31676563983419','41488629','37527457','16999467','17000478','17004550','29076809','29849934','33285494','33976467','34111282','34703639','30139645781256','29792993','29793298','30517862','32172671','33215459','34098766','217748531745840','37632191','37632227','377355641756704','377330631756667','34412437','34415655','36258373','36499995','36655720','36692995','36694330','38343263','38573565','38860927','39404472','39430267','39466225','39477656','39519301','39700936','39902812','41060094','41505374','43302030','43879168','45118871','46007942','46639517','47056208','47907488','473352912961623','36365624','36644131','36646659','36646688','41285392','41771371','46007325','47102180','366947291621789','471216092935258','395193191974555','363967691584232','367912181633672','40684143','18294740','18295092','18295845','24057824','35430361','35639879','363135391573588','182950531467066','354794501467793','26101781255364','26510022305981','354308991462940','182958611467131','18295435','24016290','25538987','26013479','35482946','36658781','215281631725535','196033071571696','195991451571355','379166071783872','379166071779509','16046162','16046311','16046369','16047790','16048672','160479891283786','160475281283762','42227851','340668361298170','355817991481255','340667091298143','130920071044331','13088680','13088771','13091519','13092220','34351806','13090791','49941267','12560352','12561504','22214310','24782414','22214222','24782225','24522162','21468633','21468670','25564507191231','14699670','40872884','378772021776091','30250942795573','378772021774014','20277899','25168430141947','20278168','24919638112520','20277614','426573992371462','426573992371465','426573992371456','31771862','32935268','34294631','38244559','38280562','39975339','46336140','46619837','46756951','47462944','31773200','44343499','44427038','44427128','25020107','26425936','29756613','29821588','30083065','32692358','460580552800923','29353278675584','40826231','40231787','31356902','36002890','40372512','29419772','29540575','31360228','36710445','30010945','29993562','30597432','31482072','49637839','49668758','49637918','49639568','49645793','49645869','49666312','49666466','49883526','31618751','31877806','326732051117397','32691630','37961639','37606327','37745532','38255480','37886014','45676398','456389542748392','456390252748402','45637155','424990542348189','424990542348196','424990542348193','425146722351020','425146722351016','425146722351012','425146722351021','42582103','43732541','425146722351017','427083002378088','427083002378094','46937408','48038779','49201271','49243519','49199527'],
    #               'select cn_doc_id, textcontent from SQLCRIS_User.Kconnect.working_docs where cn_doc_id in ({ids})',
    #               join(working_folder, "dbcnn.json"),
    #               join(working_folder, 'docs') )
    # 2. process doc
    nlp = load_mode('en')
    process_labelled_docs(join(working_folder, 'labelled.txt'),
                          join(working_folder, 'cris_hepc_model.pickle'))